 Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

# Предложение по организации инфраструктуры для разработки и эксплуатации

## Задача 1: Обеспечить разработку

Так как у нас крупная компания, необходимо настроить свою изолированную среду для хранения исходных кодов итд., поэтому репозитории Github не подойдут. Наиболее популярные решения поставленным задачам отвечает Glitlab и Jenkins.
- GitLab CI/CD может полностью контролировать Git-репозитории. Речь идёт об управлении ветками репозиториев и о некоторых других возможностях. А вот Jenkins, хотя и умеет работать с репозиториями, не даёт такого же уровня контроля над ними, как GitLab CI/CD.
- Jenkins — это бесплатный опенсорсный проект. Тот, кто его выбирает, разворачивает его самостоятельно. А GitLab CI/CD включён в состав платформы GitLab, это готовое решение.
GitLab CI/CD поддерживает развитые средства управления задачами, работающие на уровне проектов. Эта сторона Jenkins развита слабее.

С точки зрения решения из "коробки" Gitlab наиболее предпочтиелен если небходимо быстро реализовать заданные требования.
 **GitLab CI/CD для автоматизации сборок и поставок:**
   - **Запуск сборки по событию из системы контроля версий:** Триггеры на основе push, merge request и других событий.
   - **Запуск сборки по кнопке с указанием параметров:** Возможность ручного запуска пайплайнов с передачей переменных.
   - **Привязка настроек к каждой сборке:** Использование `.gitlab-ci.yml` для определения настроек каждой сборки.
   - **Создание шаблонов для различных конфигураций сборок:** Использование YAML шаблонов и включений для переиспользования конфигураций.
   - **Безопасное хранение секретных данных:** GitLab CI/CD поддерживает переменные окружения с защитой секретов.
   - **Несколько конфигураций для сборки из одного репозитория:** Определение различных пайплайнов и окружений внутри одного репозитория.
   - **Кастомные шаги при сборке:** Возможность определения пользовательских скриптов и шагов в пайплайне.
   - **Собственные докер-образы для сборки проектов:** Использование Docker images в качестве runners или в качестве сред для выполнения шагов.
   - **Развертывание агентов сборки на собственных серверах:** Настройка GitLab Runners на собственных инфраструктурах для выполнения сборок.
   - **Параллельный запуск нескольких сборок и тестов:** GitLab CI/CD поддерживает параллельные джобы и динамические пайплайны.
   - **Container registry** - реестр для образов (images) Docker.

Если для работы с контейнерами понадобится более широкий спектр задач, то следует обратить внимание на Harbor.
**Harbor**:
- Встроенное сканирование уязвимостей с использованием инструментов (Trivy, Clair и др.).
- Возможность настройки политики предотвращения загрузки уязвимых образов.
- Более гибкое управление сертификатами и политиками безопасности.
**GitLab**
- Сканирование уязвимостей контейнеров возможно через GitLab Secure, но требуется дополнительная настройка.

  ## Задача 2: Логи
Для сбора и анализа логов в микросервисной архитектуре рекомендуется использовать стек ELK (Elasticsearch, Logstash, Kibana) или его более современную альтернативу с использованием OpenSearch вместо Elasticsearch. Оба решения соответствуют требованиям, включая сбор логов, их фильтрацию, поиск, и предоставление интерфейса для пользователей, но Лицензионные ограничения Elasticsearch с версии 7.11 имеет ограниченную лицензию (SSPL), что делает его менее привлекательным.
Рекомендуемое решение: OpenSearch + Fluent Bit + OpenSearch Dashboards
**Компоненты решения**:
- Fluent Bit (агенты сбора логов)

Лёгкий агент для сбора логов, который может читать логи из stdout контейнеров или файлов.
Отправляет логи в OpenSearch с минимальными задержками.
- OpenSearch (хранилище и поиск)

Высокопроизводительная поисковая база данных для хранения логов.
Поддерживает шардирование и репликацию для обеспечения надёжности и масштабируемости.

- OpenSearch Dashboards (визуализация)

Графический интерфейс для визуализации, поиска и фильтрации логов.
Поддерживает сохранение поисков и построение дашбордов.

## Задача 3: Мониторинг
Для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре рекомендуется использовать стек Prometheus + Grafana. Это проверенное решение, которое удовлетворяет всем заявленным требованиям и обладает высокой гибкостью и масштабируемостью.
Рекомендуемое решение: **Prometheus + Grafana**
. **Сбор метрик:**
   - **Prometheus:** Устанавливается в облаке для сбора метрик со всех хостов и сервисов через HTTP.
   - **Node Exporter:** Устанавливается на каждом хосте для сбора метрик CPU, RAM, HDD, Network.
   - **Специфичные экспортеры:** Используются для сбора метрик, специфичных для каждого микросервиса (например, JVM Exporter для Java приложений).

2. **Хранение и обработка метрик:**
   - **Prometheus:** Сохраняет временные ряды метрик и обеспечивает высокую производительность при запросах.

3. **Визуализация и пользовательский интерфейс:**
   - **Grafana:** Подключается к Prometheus для создания настраиваемых дашбордов, позволяющих агрегировать и визуализировать информацию.
   - **Настраиваемые панели:** Пользователи могут создавать различные панели для отслеживания состояния системы в реальном времени.

4. **Функциональные возможности:**
   - **Сбор метрик состояния ресурсов хостов и потребляемых ресурсов сервисами:** Prometheus в сочетании с Node Exporter и сервисными экспортерами обеспечивает полный охват метрик.
   - **Специфичные метрики для каждого сервиса:** Гибкость Prometheus позволяет добавлять новые экспортеры по мере необходимости.
   - **Запросы и агрегирование информации:** PromQL в Prometheus предоставляет мощные возможности для запроса и агрегации метрик.
   - **Пользовательский интерфейс:** Grafana предоставляет удобный и интуитивно понятный интерфейс для настройки и просмотра дашбордов.

### Обоснование выбора
- Prometheus легко масштабируется горизонтально.
- Grafana может подключаться к нескольким источникам данных и поддерживать высокую доступность.
- Удобство использования.
- Интуитивно понятный интерфейс Grafana для создания и настройки дашбордов.
- Минимальные требования к приложениям
- Сбор метрик из stdout или через экспортеры без необходимости изменения кода приложений.
  
Prometheus и Grafana в настоящий момент стали практически стандартом для мониторинга и визуализации метрик в современных микросервисных архитектурах. Prometheus обеспечивает надежный и масштабируемый сбор метрик, а Grafana предоставляет мощные инструменты для создания настраиваемых панелей и визуализаций. Вместе они удовлетворяют все заявленные требования по сбору, анализу и отображению состояния системы.
